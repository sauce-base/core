name: Claude Code Review

on:
    pull_request:
        types: [labeled]

jobs:
    claude-review:
        # Only run when ai-code-review-requested label is added
        if: github.event.label.name == 'ai-code-review-requested'

        runs-on: ubuntu-latest
        permissions:
            contents: read
            pull-requests: write
            issues: read
            id-token: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Run Claude Code Review
              id: claude-review
              uses: anthropics/claude-code-action@v1
              with:
                  claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
                  prompt: |
                      REPO: ${{ github.repository }}
                      PR NUMBER: ${{ github.event.pull_request.number }}

                      Review this PR focusing on critical issues only:
                      - Security vulnerabilities (XSS, SQL injection, auth bypass, secrets in code)
                      - Obvious bugs or logic errors
                      - Breaking changes or API contract violations
                      - Missing critical error handling

                      Refer to CLAUDE.md for project conventions. Keep feedback concise and actionable.
                      Skip minor style issues (Pint/ESLint will catch those).

                      ONLY leave a comment if you find issues. Use `gh pr comment` with your Bash tool.
                      If the code looks good, exit silently without commenting.

                  # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
                  # or https://code.claude.com/docs/en/cli-reference for available options
                  claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

            - name: Update labels after review
              if: success()
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  gh pr edit ${{ github.event.pull_request.number }} \
                    --remove-label "ai-code-review-requested" \
                    --add-label "ai-code-review-finished"
